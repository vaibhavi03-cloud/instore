<script>
// ===== Setup Data =====
const svg = document.getElementById("storeMap");
let currentFloor = "Ground Floor";
let selectedItems = new Set();
let currentLocation = {x: 40, y: 550, floor: "Ground Floor"};
let items = [];

// Define categories and sample items
const categoryData = {
  "Fruits": ["ðŸŽ Apple", "ðŸŒ Banana", "ðŸŠ Orange", "ðŸ‡ Grapes", "ðŸ“ Strawberry", "ðŸ‰ Watermelon"],
  "Vegetables": ["ðŸ¥” Potato", "ðŸ¥• Carrot", "ðŸ§… Onion", "ðŸ§„ Garlic", "ðŸŒ½ Corn", "ðŸ¥¦ Broccoli"],
  "Dairy": ["ðŸ¥› Milk", "ðŸ§€ Cheese", "ðŸ¦ Ice Cream", "ðŸ¶ Yogurt", "ðŸ§ˆ Butter"],
  "Bakery": ["ðŸ¥– Bread", "ðŸ© Donut", "ðŸ¥ Croissant", "ðŸª Cookies", "ðŸ° Cake"],
  "Electronics": ["ðŸ’» Laptop", "ðŸ“± Smartphone", "ðŸŽ§ Headphones", "ðŸ“º TV", "âŒš Smartwatch"],
  "Clothing": ["ðŸ‘• T-shirt", "ðŸ‘– Jeans", "ðŸ‘— Dress", "ðŸ§¥ Jacket", "ðŸ‘Ÿ Shoes"]
};

const colors = {
  "Fruits": "#ffe6e6",
  "Vegetables": "#e6ffe6",
  "Dairy": "#e6f0ff",
  "Bakery": "#fff3e6",
  "Electronics": "#e6f7ff",
  "Clothing": "#f5e6ff",
  "Facility": "#ffdd57"
};

// Generate items by section and position
let y = 100;
let x = 100;
for (let [category, names] of Object.entries(categoryData)) {
  names.forEach((name, i) => {
    items.push({
      name: name,
      brand: ["BrandA", "BrandB", "BrandC"][i % 3],
      floor: "Ground Floor",
      category: category,
      aisle: `${category[0]}-${i + 1}`,
      cost: Math.floor(Math.random() * 400) + 50,
      x: x + (i * 90),
      y: y
    });
  });
  y += 90;
  if (y > 450) { y = 100; x += 180; } // Adjust to create new columns after some rows
}

// Add special facilities
items.push({ name: "ðŸš» Washroom", floor: "Ground Floor", category: "Facility", facility: true, x: 60, y: 500 });
items.push({ name: "ðŸ›— Lift", floor: "Ground Floor", category: "Facility", facility: true, x: 550, y: 500 });
items.push({ name: "ðŸ§â€â™‚ï¸ Trial Room", floor: "First Floor", category: "Facility", facility: true, x: 900, y: 450 });

// ===== Display Items =====
function displayItems(filtered = items) {
  const list = document.getElementById("itemList");
  list.innerHTML = "";
  filtered.forEach(item => {
    if (item.floor !== currentFloor || item.facility) return;
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <h3>${item.name}</h3>
      <p>Brand: ${item.brand}</p>
      <p>Category: ${item.category}</p>
      <p>Cost: â‚¹${item.cost}</p>
      <button onclick="toggleSelect('${item.name}', this)">Select</button>`;
    list.appendChild(div);
  });
}

// ===== Draw Map =====
function drawMap() {
  svg.innerHTML = "";
  const start = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  start.setAttribute("cx", currentLocation.x);
  start.setAttribute("cy", currentLocation.y);
  start.setAttribute("r", 12);
  start.setAttribute("fill", "blue");
  svg.appendChild(start);

  items.forEach(item => {
    if (item.floor !== currentFloor) return;
    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", item.x);
    rect.setAttribute("y", item.y);
    rect.setAttribute("width", 70);
    rect.setAttribute("height", 50);
    rect.setAttribute("fill", colors[item.category] || "#ffffff");
    rect.setAttribute("stroke", "#0078d7");
    rect.setAttribute("rx", 10);
    svg.appendChild(rect);

    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", item.x + 35);
    text.setAttribute("y", item.y + 30);
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("font-size", "11");
    text.textContent = item.name;
    svg.appendChild(text);
  });
}

// ===== Select Item =====
function toggleSelect(name, btn) {
  if (selectedItems.has(name)) {
    selectedItems.delete(name);
    btn.innerText = "Select";
    btn.parentElement.classList.remove("selected");
  } else {
    selectedItems.add(name);
    btn.innerText = "Deselect";
    btn.parentElement.classList.add("selected");
  }
}

// ===== Filtering =====
function filterItems() {
  const search = document.getElementById("searchBox").value.toLowerCase();
  const category = document.getElementById("categoryFilter").value;
  const filtered = items.filter(i =>
    i.name.toLowerCase().includes(search) &&
    (category === "" || i.category === category) &&
    i.floor === currentFloor
  );
  displayItems(filtered);
}

// ===== Floor Change =====
function changeFloor() {
  currentFloor = document.getElementById("floorFilter").value;
  displayItems();
  drawMap();
}

// ===== Voice Navigation =====
function speak(text) {
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = "en-IN";
  msg.rate = 1;
  speechSynthesis.speak(msg);
}

// ===== Show Route =====
function showRoute() {
  if (selectedItems.size === 0) {
    alert("Select at least one item!");
    speak("Please select at least one item to navigate.");
    return;
  }

  const routeInfo = document.getElementById("routeInfo");
  const selected = items.filter(i => selectedItems.has(i.name));
  const grouped = {};
  selected.forEach(i => {
    if (!grouped[i.floor]) grouped[i.floor] = [];
    grouped[i.floor].push(i);
  });

  let routeText = "";
  for (let floor in grouped) {
    routeText += `ðŸ§­ ${floor}: ${grouped[floor].map(i => i.name).join(", ")}<br>`;
  }

  routeInfo.innerHTML = routeText;
  routeInfo.style.display = "block";
  speak("Starting navigation...");

  for (let floor in grouped) {
    speak(`Now move to ${floor}`);
    grouped[floor].forEach(item => {
      speak(`Find ${item.name} in ${item.category} section.`);
    });
  }

  drawMap();
  let floorItems = grouped[currentFloor] || [];
  if (floorItems.length === 0) return;

  let pathData = `M${currentLocation.x},${currentLocation.y}`;
  floorItems.forEach(item => pathData += ` L${item.x + 35},${item.y + 25}`);
  const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
  path.setAttribute("d", pathData);
  path.setAttribute("fill", "none");
  path.setAttribute("stroke", "#0078d7");
  path.setAttribute("stroke-width", "4");
  path.setAttribute("stroke-dasharray", "6,8");
  svg.appendChild(path);

  const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  dot.setAttribute("r", 8);
  dot.setAttribute("fill", "red");
  dot.style.offsetPath = `path('${pathData}')`;
  dot.style.animation = "moveDot 6s linear infinite";
  svg.appendChild(dot);
}

displayItems();
drawMap();
</script>
